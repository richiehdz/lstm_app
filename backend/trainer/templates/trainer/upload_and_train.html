{% extends "base.html" %}

{% block content %}

<style>
  body {
    font-family: "Inter", "Segoe UI", Arial, sans-serif;
    background: #F4F6F9;
  }

  .trainer-panel {
    max-width: 900px;
    margin: 60px auto 40px auto;
    background: #FFFFFF;
    border-radius: 12px;
    box-shadow: 0px 8px 20px rgba(0,0,0,0.06);
    padding: 35px 40px;
  }

  .back-btn {
    display: inline-block;
    margin-bottom: 20px;
    padding: 10px 14px;
    background: #1A73E8;
    color: white;
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    transition: background 0.25s, transform 0.15s;
    box-shadow: 0px 3px 7px rgba(0,0,0,0.08);
  }

  .back-btn:hover {
    background: #1558B0;
    transform: translateY(-2px);
  }

  .back-btn:active {
    transform: translateY(0);
  }

  h1 {
    margin-top: 0;
    margin-bottom: 12px;
    color: #15202B;
    font-size: 26px;
    font-weight: 700;
  }

  p.text-muted,
  .description {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 14px;
    line-height: 1.6;
    color: #4A5568;
  }

  .small-note {
    font-size: 12px;
    color: #718096;
    margin-bottom: 25px;
  }

  .alert-error {
    background: #FEE2E2;
    border: 1px solid #FCA5A5;
    color: #B91C1C;
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 14px;
    margin-bottom: 18px;
  }

  .card-panel {
    background: #F9FAFB;
    border-radius: 10px;
    padding: 20px 22px;
    margin-bottom: 24px;
    border: 1px solid #E1E8F0;
  }

  .card-title {
    margin-top: 0;
    margin-bottom: 12px;
    font-size: 18px;
    font-weight: 600;
    color: #1A202C;
  }

  label.form-label {
    display: block;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 6px;
    color: #1A202C;
  }

  input[type="file"].form-control {
    display: block;
    width: 100%;
    padding: 8px;
    background: #F7FAFC;
    border-radius: 8px;
    border: 1px solid #CBD5E0;
    font-size: 14px;
    cursor: pointer;
  }

  input[type="file"].form-control:focus {
    outline: none;
    border-color: #1A73E8;
    box-shadow: 0 0 0 1px rgba(26,115,232,0.35);
  }

  .form-text {
    font-size: 12px;
    color: #718096;
    margin-top: 4px;
  }

  button[type="submit"].primary-btn {
    margin-top: 10px;
    padding: 12px 18px;
    background: #1A73E8;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0px 3px 7px rgba(0,0,0,0.08);
    transition: background 0.25s, transform 0.15s;
  }

  button[type="submit"].primary-btn:hover {
    background: #1558B0;
    transform: translateY(-1px);
  }

  button[type="submit"].primary-btn:active {
    transform: translateY(0);
    box-shadow: 0px 2px 5px rgba(0,0,0,0.08);
  }

  .secondary-btn {
    display: inline-block;
    padding: 10px 16px;
    background: #16A34A;
    color: white;
    text-decoration: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0px 3px 7px rgba(0,0,0,0.08);
    transition: background 0.25s, transform 0.15s;
  }

  .secondary-btn:hover {
    background: #15803D;
    transform: translateY(-1px);
  }

  .secondary-btn:active {
    transform: translateY(0);
  }

  .results-panel h5 {
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 18px;
    font-weight: 600;
    color: #1A202C;
  }

  .results-panel h6 {
    margin-top: 18px;
    font-size: 15px;
    font-weight: 600;
    color: #2D3748;
  }

  .table-responsive {
    margin-top: 10px;
    max-height: 400px;
    overflow: auto;
    border-radius: 8px;
    border: 1px solid #E2E8F0;
    background: #FFFFFF;
  }

  .table-responsive table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .table-responsive th,
  .table-responsive td {
    padding: 6px 8px;
    border: 1px solid #E2E8F0;
  }

  .table-responsive th {
    background: #F7FAFC;
    font-weight: 600;
  }
</style>

<div class="trainer-panel">

  <a class="back-btn" href="{% url 'trainer:home' %}">
    ‚Üê Volver al inicio
  </a>

  <h1>Entrenar modelo LSTM de demanda de cupos</h1>

  <p class="text-muted">
    Sube el dataset final generado por los otros m√≥dulos
    (oferta + preregistro + imputaci√≥n). El sistema entrenar√° un modelo LSTM
    con una configuraci√≥n fija y te devolver√° un archivo CSV con las predicciones,
    adem√°s de mostrarlas en una tabla.
  </p>

  <p class="small-note">
    Nota: el entrenamiento puede tardar algunos segundos o minutos dependiendo
    del tama√±o del dataset y los par√°metros del modelo.
  </p>

  {# Mensajes de error generales #}
  {% if error %}
    <div class="alert-error">
      {{ error }}
    </div>
  {% endif %}

  {# FORMULARIO DE SUBIDA #}
  <div class="card-panel">
    <h5 class="card-title">Subir dataset final</h5>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      {# Archivo CSV #}
      <div class="mb-3">
        <label for="id_file" class="form-label">
          Dataset final (.csv)
        </label>
        <input
          type="file"
          class="form-control"
          id="id_file"
          name="file"
          accept=".csv"
          required
        >
        <div class="form-text">
          Debe ser el dataset ya procesado (oferta + preregistro + imputaci√≥n),
          con las columnas esperadas por el modelo.
        </div>
      </div>

      {# üîí Configuraci√≥n fija del modelo (oculta para el usuario) #}
      <input type="hidden" name="target_column" value="cupos_usados">

      <input
        type="hidden"
        name="input_columns"
        value="materia_codificada,Total_Cupos,Total_Secciones,Residuos_Cupos,semestre_numerico,nuevos_alumnos,lag1_cupos_usados,preregistrados"
      >

      <input type="hidden" name="window_size" value="3">
      <input type="hidden" name="epochs" value="150">

      <button type="submit" class="primary-btn">
        Entrenar modelo y generar predicciones
      </button>
    </form>
  </div>

  {# RESULTADOS: LINK AL CSV Y TABLA HTML #}
  {% if csv_url or table_html %}
    <div class="card-panel results-panel">
      <h5 class="card-title">Resultados del modelo</h5>

      {% if csv_url %}
        <p>
          <a href="{{ csv_url }}" class="secondary-btn">
            Descargar predicciones en CSV
          </a>
        </p>
      {% endif %}

      {% if table_html %}
        <h6 class="mt-3">Vista previa de predicciones</h6>
        <div class="table-responsive">
          {{ table_html|safe }}
        </div>
      {% endif %}
    </div>
  {% endif %}

</div>

{% endblock %}
